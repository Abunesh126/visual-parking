version: '3.8'

services:
  # Entry Pipeline Service
  cv-entry:
    build: .
    container_name: parking-cv-entry
    restart: unless-stopped
    environment:
      - BACKEND_URL=${BACKEND_URL}
      - ENTRY_CAMERA_URL=${ENTRY_CAMERA_URL}
      - LOG_LEVEL=INFO
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./.env:/app/.env
    command: python src/main_entry.py --camera ${ENTRY_CAMERA_URL}
    networks:
      - parking-network
    depends_on:
      - backend

  # Exit Pipeline Service (V3)
  cv-exit:
    build: .
    container_name: parking-cv-exit
    restart: unless-stopped
    environment:
      - BACKEND_URL=${BACKEND_URL}
      - EXIT_CAMERA_URL=${EXIT_CAMERA_URL}
      - LOG_LEVEL=INFO
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./.env:/app/.env
    command: python src/main_exit.py --camera ${EXIT_CAMERA_URL}
    networks:
      - parking-network
    depends_on:
      - backend

  # Floor A - Car Cameras (10 cameras, 4 slots each)
  cv-floor-a-car-1:
    build: .
    container_name: parking-cv-floor-a-car-1
    restart: unless-stopped
    environment:
      - BACKEND_URL=${BACKEND_URL}
      - CAMERA_URL=${FLOOR_A_CAR_CAM_1}
      - LOG_LEVEL=INFO
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./parking_spots.json:/app/parking_spots.json
      - ./.env:/app/.env
    command: python src/main_indoor.py --camera ${FLOOR_A_CAR_CAM_1} --spots-config parking_spots.json --camera-id FLOOR_A_CAR_CAM_1
    networks:
      - parking-network
    depends_on:
      - backend

  cv-floor-a-car-2:
    build: .
    container_name: parking-cv-floor-a-car-2
    restart: unless-stopped
    environment:
      - BACKEND_URL=${BACKEND_URL}
      - CAMERA_URL=${FLOOR_A_CAR_CAM_2}
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./parking_spots.json:/app/parking_spots.json
    command: python src/main_indoor.py --camera ${FLOOR_A_CAR_CAM_2} --spots-config parking_spots.json --camera-id FLOOR_A_CAR_CAM_2
    networks:
      - parking-network
    depends_on:
      - backend

  # ... Repeat for cv-floor-a-car-3 through cv-floor-a-car-10
  # (Similar configuration, just change camera numbers)

  # Floor A - Bike Cameras (4 cameras, 8 slots each)
  cv-floor-a-bike-1:
    build: .
    container_name: parking-cv-floor-a-bike-1
    restart: unless-stopped
    environment:
      - BACKEND_URL=${BACKEND_URL}
      - CAMERA_URL=${FLOOR_A_BIKE_CAM_1}
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./parking_spots.json:/app/parking_spots.json
    command: python src/main_indoor.py --camera ${FLOOR_A_BIKE_CAM_1} --spots-config parking_spots.json --camera-id FLOOR_A_BIKE_CAM_1
    networks:
      - parking-network
    depends_on:
      - backend

  # ... Repeat for cv-floor-a-bike-2 through cv-floor-a-bike-4

  # Floor B - Car Cameras (10 cameras)
  cv-floor-b-car-1:
    build: .
    container_name: parking-cv-floor-b-car-1
    restart: unless-stopped
    environment:
      - BACKEND_URL=${BACKEND_URL}
      - CAMERA_URL=${FLOOR_B_CAR_CAM_1}
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./parking_spots.json:/app/parking_spots.json
    command: python src/main_indoor.py --camera ${FLOOR_B_CAR_CAM_1} --spots-config parking_spots.json --camera-id FLOOR_B_CAR_CAM_1
    networks:
      - parking-network
    depends_on:
      - backend

  # ... Repeat for cv-floor-b-car-2 through cv-floor-b-car-10

  # Floor B - Bike Cameras (4 cameras)
  cv-floor-b-bike-1:
    build: .
    container_name: parking-cv-floor-b-bike-1
    restart: unless-stopped
    environment:
      - BACKEND_URL=${BACKEND_URL}
      - CAMERA_URL=${FLOOR_B_BIKE_CAM_1}
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./parking_spots.json:/app/parking_spots.json
    command: python src/main_indoor.py --camera ${FLOOR_B_BIKE_CAM_1} --spots-config parking_spots.json --camera-id FLOOR_B_BIKE_CAM_1
    networks:
      - parking-network
    depends_on:
      - backend

  # ... Repeat for cv-floor-b-bike-2 through cv-floor-b-bike-4

  # Backend API (placeholder - should be in separate repository)
  backend:
    image: parking-backend:latest
    container_name: parking-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=mysql://user:password@db:3306/parking
    networks:
      - parking-network
    depends_on:
      - db

  # Database
  db:
    image: mysql:8.0
    container_name: parking-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=parking
      - MYSQL_USER=user
      - MYSQL_PASSWORD=password
    volumes:
      - mysql-data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    networks:
      - parking-network

  # Optional: Redis for caching
  redis:
    image: redis:7-alpine
    container_name: parking-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - parking-network

  # Optional: Monitoring with Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: parking-prometheus
    restart: unless-stopped
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - parking-network

  # Optional: Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: parking-grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
    ports:
      - "3000:3000"
    networks:
      - parking-network
    depends_on:
      - prometheus

networks:
  parking-network:
    driver: bridge

volumes:
  mysql-data:
  prometheus-data:
  grafana-data:
